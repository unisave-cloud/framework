# DLL file distribution

The Unisave Framework DLL(s) are created in this repository when the solution is built by Rider. Ultimately, they need to be present in these places:

- **Unisave Asset** so that the client-side can use the serializer, the RPC framework, the IoC container, etc. It has to ship as a DLL with the asset on the Unity Asset Store as part of the `.unitypackage`.
- **Compiler** so that when the user's backend code is compiled, it has access to the proper Unisave Framework DLL to bake into the backend DLL proper assembly references.
- **Worker (initializer)** so that when the worker is initialized and the user's backend assembly is downloaded, the correct framework DLL is also downloaded.

The distribution is managed by having a folder with all known framework versions uploaded in the cluster object storage, that the compiler and workers can access to download the DLLs. Compiler downloads these directly and the worker does so indirectly via signed object storage URLs generated by the worker initialization logic (the code that generates initialization recipes).

This folder with unisave frameworks is directly mirrored in this repository (though not tracked in git) in the `releases` folder. The `s3cmd` tool is used to upload/download this folder to/from the cluster and these actions are hidden behind these `Makefile` commands:

```bash
make upload-frameworks-dev
make upload-frameworks-stage
make upload-frameworks-prod
make download-frameworks-prod
```

If the `releases` folder in this repository is empty (containing only the gitignore file), download its current state from the production cluster first:

```bash
make download-frameworks-prod
```

This removes any additional local file and downloads missing local files. It will get to the exact same state as it is on the production cluster.

The `releases` folder contains one sub-folder per framework version, like so:

```
releases/
    ...
    0.10.0/
    0.10.1/
    0.10.1-dev/
    0.10.2/
    0.10.2-dev/
    0.10.3/
    0.10.3-dev/
    0.10.3-rc.1/
    0.10.3-rc.2/
    0.10.3-rc.2.dev/
    0.11.0/
    0.11.0-dev/
    ...
```

Each of these folders contains the framework DLL, its PDB file and all dependencies:

```
releases/
    0.11.0/
        LightJson.dll
        LightJson.pdb
        Microsoft.Owin.dll
        Microsoft.Owin.xml
        Owin.dll
        UnisaveFramework.dll
        UnisaveFramework.pdb
        UnisaveJWT.dll
        UnityEngine.dll
        UnityEngine.pdb
```

There is also the `latest.txt` file which contains the version of the latest framework (updated each time you do `make copy-dll-to-asset-and-releases`). This file was likely prepared for some feature that was never added. There is not a single line of code referencing this file in all Unisave repositories. It can probbably be deleted during the next refactoring of the DLL distribution logic.

> **Note:** My guess is that it was intended for the compiler to know which version to use when compiling backend code, but then I realized that the asset has to send its framework version anyways, so it wasn't necessary.
